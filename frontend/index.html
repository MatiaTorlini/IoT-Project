<!--													H T M L -->

<!DOCTYPE html>
<html lang="en">


<!--													H E A D 											-->

<head>
	<meta charset="utf-8">

	<!--#region-->
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script src="https://cesium.com/downloads/cesiumjs/releases/1.112/Build/Cesium/Cesium.js"></script>
	<link href="https://cesium.com/downloads/cesiumjs/releases/1.112/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
	<!--#endregion-->

	<!--													C S S  											-->

	<style>
		/*#region*/
		.row {
			display: -webkit-flex;
			display: flex;
		}

		/*#endregion*/


		/*#region*/
		.column {
			-webkit-flex: 1;
			-ms-flex: 1;
			flex: 1;
			padding: 10px;
			height: 500px;
		}

		/*#endregion*/

		/*#region*/
		.header {
			background-color: #f1f1f1;
			padding: 10px;
			text-align: center;
		}

		/*#endregion*/

		/*#region*/
		.sidenav {
			height: 100%;
			width: 200px;
			position: fixed;
			z-index: 1;
			top: 0;
			left: 0;
			background-color: #111;
			overflow-x: hidden;
		}

		/*#endregion*/

		/*#region*/
		.sidenav a {
			color: white;
			padding: 16px;
			text-decoration: none;
			display: block;
		}

		/*#endregion*/

		/*#region*/
		.sidenav p {
			font-size: large;
			color: rgb(95, 236, 0);
			padding: 16px;
			text-decoration: none;
			display: block;
		}

		/*#endregion*/

		/*#region*/
		.sidenav a:hover {
			background-color: #ddd;
			color: black;
		}

		/*#endregion*/

		/*#region*/
		.content {
			margin-left: 200px;
			padding-left: 20px;
			margin-right: 50px;
			padding-right: 20px;
		}

		/*#endregion*/

		/*#region*/
		.cesiumContainer {
			width: 60%;
			padding: 10px;
			max-height: 400px;
		}

		/*#endregion*/

		/*#region*/
		.plotContainer {
			width: 40%;
			padding: 10px;
			max-height: 400px;
			margin-top: 100px
		}

		/*#endregion*/
	</style>
</head>
<!--														B O D Y 											-->


<body>
	<!--region-->
	<h2 class="header">Cesium for EnergyCenter Torino</h2>
	<!--endregion-->

	<!--region-->
	<div class="sidenav">
		<p href="#">EnergyCenter Polito</p>
		<a href="#">City</a>
		<a href="#">Dashboard</a>
		<a href="#">About</a>
	</div>
	<!--endregion-->

	<!--region-->
	<div class="content">
		<div class="row">
			<div id="cesiumContainer" class="cesiumContainer column"></div>
			<div class="column plotContainer">
				<canvas id="myChart"></canvas>
			</div>
		</div>
	</div>
	<!--endregion-->


	<!--													J A V A S C R I P T 											-->
	<script type="module">
		// Your access token can be found at: https://ion.cesium.com/tokens.
		// This is the default access token from your ion account
		Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJiZDFhNDY4NS00M2UyLTQ3MGQtODIyOC00NDJjZGZjOGY2MDIiLCJpZCI6MTgzMTkxLCJpYXQiOjE3MDE5NzMyNDl9.GpCRKJliN686CgUWw9RPqvukFcyK934grdVgO7zVeVw';


		//<!--													C L A S S E S   											-->
		//#####################################################################################################################

		class StreamManager {
			___streaming_source = null;
			constructor() { }

			//#region
			_stop__streaming = async () => {
				await fetch('http://localhost:8081/stop', 
				{
					method:'POST'
				})
					.then(response => { if (!response.ok) { throw new Error('Network response was not ok'); } })
				this.___streaming_source.close();
			}
			//#endregion


			//#region
			_start__streaming = () => {
				const res = fetch('http://localhost:8082', //devices variable contains a list of devices' IDs mounted on the selected building
					{
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify(building_data)
					})
					.then(response =>
						response.json())
					.then(data => {
						deviceId = data[0].CityObject.devices[0].device_id;
						devices = data
						console.log(deviceId)
						return fetch(`http://localhost:8081/start`,
							{
								method: 'POST',
								//headers: { 'Content-Type': 'application/json' },
								body: JSON.stringify(deviceId)
							})
							.then(response => {
								if (!response.ok) { throw new Error('Network response was not ok'); }
								this.___streaming_source = new EventSource('http://localhost:8081/events', 
								{
									method : 'POST',
									
								});
								this.___streaming_source.onmessage = (event) => {
									// use data to plot
									dataPoints.push(event.data)
									myChart.data.labels.push(event.data)
									myChart.update()
								};
								this.___streaming_source.onopen = () => { console.log("Connection established, ready to accept events"); };
								this.___streaming_source.onerror = (error) => { console.error("Error:", error); this.___streaming_source.close(); };
							})
					})

				//here take the list of device IDs in {device} and 
				//fetch a request to Influx to publish data for each one on a specific event.
				//see MDN docs for SSE EventSource. Actually only just one event is streamed


			}
			//#endregion
		}


		//#####################################################################################################################



		//<!--													V A R I A B L E S  											-->
		//#####################################################################################################################


		const building_data = { //static, need to load from fetch to mongo on feature picked
			building_id: 123
		}

		let devices = [] //to store the response of mongodb
		let deviceId = undefined

		const ___stream__manager = new StreamManager(); //to manage streaming

		var dataPoints = []; //to store data points incoming from influx

		const viewer = new Cesium.Viewer('cesiumContainer', {  //cesium default viewer
			terrain: Cesium.Terrain.fromWorldTerrain(),
			animation: false,
			timeline: false,
			navigationHelpButton: false,
			vrButton: false,
			fullscreenButton: false,
		});

		const tileset = viewer.scene.primitives.add(		   //CityGml hosted on IoN asset
			await Cesium.Cesium3DTileset.fromIonAssetId(2393585)
		);

		//#####################################################################################################################


		// HTML overlay for showing feature name on mouseover
		const nameOverlay = document.createElement("div");
		viewer.container.appendChild(nameOverlay);
		nameOverlay.className = "backdrop";
		nameOverlay.style.display = "none";
		nameOverlay.style.position = "absolute";
		nameOverlay.style.bottom = "0";
		nameOverlay.style.left = "0";
		nameOverlay.style["pointer-events"] = "none";
		nameOverlay.style.padding = "4px";
		nameOverlay.style.backgroundColor = "black";

		// Information about the currently selected feature
		const selected = {
			feature: undefined,
			originalColor: new Cesium.Color(),
		};

		// An entity object which will hold info about the currently selected feature for infobox display
		const selectedEntity = new Cesium.Entity();

		// Get default left click handler for when a feature is not picked on left click
		const clickHandler = viewer.screenSpaceEventHandler.getInputAction(
			Cesium.ScreenSpaceEventType.LEFT_CLICK
		);

		// Update the 'nameOverlay' for the given picked feature,
		// at the given (screen) position.
		function updateNameOverlay(pickedFeature, position) {
			if (!Cesium.defined(pickedFeature)) {

				nameOverlay.style.display = "none";
				return;
			}
			// A feature was picked, so show its overlay content
			nameOverlay.style.display = "block";
			nameOverlay.style.bottom = `${viewer.canvas.clientHeight - position.y
				}px`;
			nameOverlay.style.left = `${position.x}px`;
			const name = pickedFeature.getProperty("BIN");
			nameOverlay.textContent = name;
		}

		// Create the HTML that will be put into the info box that shows
		// information about the currently selected feature
		function createPickedFeatureDescription(pickedFeature) {
			const description =
				`${'<table class="cesium-infoBox-defaultTable"><tbody>' +
				"<tr><th>BIN</th><td>"
				}${pickedFeature.getProperty("BIN")}</td></tr>` +
				`<tr><th>DOITT ID</th><td>${pickedFeature.getProperty(
					"DOITT_ID"
				)}</td></tr>` +
				`<tr><th>SOURCE ID</th><td>${pickedFeature.getProperty(
					"SOURCE_ID"
				)}</td></tr>` +
				`<tr><th>Longitude</th><td>${pickedFeature.getProperty(
					"Longitude"
				)}</td></tr>` +
				`<tr><th>Latitude</th><td>${pickedFeature.getProperty(
					"Latitude"
				)}</td></tr>` +
				`<tr><th>Height</th><td>${pickedFeature.getProperty(
					"Height"
				)}</td></tr>` +
				`<tr><th>Terrain Height (Ellipsoid)</th><td>${pickedFeature.getProperty(
					"TerrainHeight"
				)}</td></tr>` +
				`</tbody></table>`;
			return description;
		}

		// If silhouettes are supported, silhouette features in blue on mouse over and silhouette green on mouse click.
		// If silhouettes are not supported, change the feature color to yellow on mouse over and green on mouse click.
		if (
			Cesium.PostProcessStageLibrary.isSilhouetteSupported(viewer.scene)
		) {
			// Silhouettes are supported
			const silhouetteBlue = Cesium.PostProcessStageLibrary.createEdgeDetectionStage();
			silhouetteBlue.uniforms.color = Cesium.Color.BLUE;
			silhouetteBlue.uniforms.length = 0.01;
			silhouetteBlue.selected = [];

			const silhouetteGreen = Cesium.PostProcessStageLibrary.createEdgeDetectionStage();
			silhouetteGreen.uniforms.color = Cesium.Color.LIME;
			silhouetteGreen.uniforms.length = 0.01;
			silhouetteGreen.selected = [];

			viewer.scene.postProcessStages.add(
				Cesium.PostProcessStageLibrary.createSilhouetteStage([
					silhouetteBlue,
					silhouetteGreen,
				])
			);

			// Silhouette a feature blue on hover.
			viewer.screenSpaceEventHandler.setInputAction(function onMouseMove(
				movement
			) {
				// If a feature was previously highlighted, undo the highlight
				silhouetteBlue.selected = [];


				// Pick a new feature
				const pickedFeature = viewer.scene.pick(movement.endPosition);

				updateNameOverlay(pickedFeature, movement.endPosition);

				if (!Cesium.defined(pickedFeature)) {
					return;
				}

				// Highlight the feature if it's not already selected.
				if (pickedFeature !== selected.feature) {
					silhouetteBlue.selected = [pickedFeature];
				}
			},
				Cesium.ScreenSpaceEventType.MOUSE_MOVE);

			// Silhouette a feature on selection and show metadata in the InfoBox.
			viewer.screenSpaceEventHandler.setInputAction(function onLeftClick(
				movement
			) {
				// If a feature was previously selected, undo the highlight
				silhouetteGreen.selected = [];


				// Pick a new feature
				const pickedFeature = viewer.scene.pick(movement.position);
				if (!Cesium.defined(pickedFeature)) {
					clickHandler(movement);
					___stream__manager._stop__streaming()
					return;
				}


				___stream__manager._start__streaming()

				//A S K - F O R - D E V I C E S - I N - C L I C K E D - B U I L D I N G - A N D - S T A R T - S T R E A M I N G
				//##############################################################################################################

				//fetch to MongoDB


				//##############################################################################################################






				// Select the feature if it's not already selected
				if (silhouetteGreen.selected[0] === pickedFeature) {
					return;
				}

				// Save the selected feature's original color
				const highlightedFeature = silhouetteBlue.selected[0];
				if (pickedFeature === highlightedFeature) {
					silhouetteBlue.selected = [];
				}

				// Highlight newly selected feature
				silhouetteGreen.selected = [pickedFeature];

				// Set feature infobox description
				viewer.selectedEntity = selectedEntity;
				selectedEntity.description = createPickedFeatureDescription(
					pickedFeature
				);
			},
				Cesium.ScreenSpaceEventType.LEFT_CLICK);
		} else {
			// Silhouettes are not supported. Instead, change the feature color.

			// Information about the currently highlighted feature
			const highlighted = {
				feature: undefined,
				originalColor: new Cesium.Color(),
			};

			// Color a feature yellow on hover.
			viewer.screenSpaceEventHandler.setInputAction(function onMouseMove(
				movement
			) {
				// If a feature was previously highlighted, undo the highlight
				if (Cesium.defined(highlighted.feature)) {
					highlighted.feature.color = highlighted.originalColor;
					highlighted.feature = undefined;
				}
				// Pick a new feature
				const pickedFeature = viewer.scene.pick(movement.endPosition);
				updateNameOverlay(pickedFeature, movement.endPosition);

				if (!Cesium.defined(pickedFeature)) {
					return;
				}

				// Highlight the feature if it's not already selected.
				if (pickedFeature !== selected.feature) {
					highlighted.feature = pickedFeature;
					Cesium.Color.clone(
						pickedFeature.color,
						highlighted.originalColor
					);
					pickedFeature.color = Cesium.Color.YELLOW;
				}
			},
				Cesium.ScreenSpaceEventType.MOUSE_MOVE);

			// Color a feature on selection and show metadata in the InfoBox.
			viewer.screenSpaceEventHandler.setInputAction(function onLeftClick(
				movement
			) {
				// If a feature was previously selected, undo the highlight
				if (Cesium.defined(selected.feature)) {

					selected.feature.color = selected.originalColor;
					selected.feature = undefined;
				}
				// Pick a new feature
				const pickedFeature = viewer.scene.pick(movement.position);



				//B U I L D I N G - D R O P P E D - S T O P - S T R E A M I N G
				//##############################################################################################################

				if (!Cesium.defined(pickedFeature)) {
					___stream__manager._stop__streaming()
					clickHandler(movement);
					return;
				}
				//##############################################################################################################




				// Select the feature if it's not already selected
				if (selected.feature === pickedFeature) {
					return;
				}
				selected.feature = pickedFeature;
				// Save the selected feature's original color
				if (pickedFeature === highlighted.feature) {
					Cesium.Color.clone(
						highlighted.originalColor,
						selected.originalColor
					);
					highlighted.feature = undefined;
				} else {
					Cesium.Color.clone(pickedFeature.color, selected.originalColor);
				}
				// Highlight newly selected feature
				pickedFeature.color = Cesium.Color.LIME;

				// Set feature infobox description
				viewer.selectedEntity = selectedEntity;
				selectedEntity.description = createPickedFeatureDescription(
					pickedFeature
				);
			},
				Cesium.ScreenSpaceEventType.LEFT_CLICK);
		}





		//													P L O T - S E T U P
		//########################################################################################################################

		// Get the canvas element
		var ctx = document.getElementById('myChart').getContext('2d');

		// Create the initial chart with an empty dataset
		var myChart = new Chart(ctx, {
			type: 'line',
			data: {
				labels: [],
				datasets: [{
					label: 'Incoming Data',
					data: dataPoints,
					borderColor: 'rgba(75, 192, 192, 1)',
					borderWidth: 1,
					fill: false
				}]
			},
			options: {
				scales: {
					x: [{
						type: 'linear',
						position: 'bottom'
					}]
				}
			}
		});

		//########################################################################################################################	
	</script>
</body>

</html>